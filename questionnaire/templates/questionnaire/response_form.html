{% extends 'questionnaire/base.html' %}
{% load static %}

{% block body %}
    <div id='project_title'>
        <h1>The removal of street art from the street: <br>the transformation of the playful politics of place</h1>
    </div>    
    <p>To what extend do you agree with each statement. Please rank on a scale of 1 to 5, with 1 being not at all and 5 being fully.</p>
    <div>
        <form method="POST" class="ResponseForm">{% csrf_token %}
            {{ form.as_p }}
            </div>
            <button type="submit">Next Questions???</button>
        <p>Draw a frame around what you think encompasses the artwork or where the boundary of the artwork might be. 
            <br>You can use the ‘Change background’ button to decide what image of the artwork to use. 
            <br>Draw by clicking and dragging your mouse. If you wish to reset the image, click the ‘Clear’ button. (An example of this question is below
            </p>
        <div id="canvas-holder">
            <canvas id="canvas"></canvas>
        </div>
        <div id='submit'>
            <button type="submit">Submit</button>
        </div>
    </form>
    <div id='clear'>
        <button onclick="clearCanvas()">Clear</button>
    </div>
    <div id=change_background>
        <button id=change_background_btn, onclick="changeBackground()">Change image</button>
    </div>
    <script>
        var images = [
            '{% static "questionnaire/canvas_background.jpg" %}',
            '{% static "questionnaire/canvas_background1.jpg" %}',
            '{% static "questionnaire/canvas_background2.jpg" %}',
            '{% static "questionnaire/canvas_background3.jpg" %}'
        ]

        function preloadImages(array) {
            var count = 0;
            if (!preloadImages.list) {
                preloadImages.list = [];
            }
            var list = preloadImages.list;
            for (var i = 0; i < array.length; i++) {
                var img = new Image();
                img.onload = function() {
                    count += 1;
                    if (count == array.length) {
                        setBackground('{% static "questionnaire/canvas_background.jpg" %}')
                    }
                }
                list.push(img);
                img.src = array[i];
            }    
        }

        preloadImages(images);

        var drawing_field = document.getElementById("id_drawing");
        // get canvas
        var canvas = document.getElementById("canvas")

        // get canvas 2D context and set him correct size
        var ctx = canvas.getContext('2d');

        var background_num = 0;

        // last known position
        var pos = { x: 0, y: 0 };

        document.addEventListener('mousemove', draw);
        document.addEventListener('mousedown', setPosition);
        document.addEventListener('mouseup', save);
        document.addEventListener('mouseenter', setPosition);
        document.addEventListener('mouseleave', save);

        function changeBackground() {
            background_num += 1;
            if (background_num == images.length) {
                background_num = 0;
            }

            setBackground(images[background_num]);
        }

        function clearCanvas() {
            setBackground(images[background_num]);
        }

        function setBackground(url) {
            var background = new Image();

            background.onload = function(){
                ctx.drawImage(background,0,0);   
            };
            background.src = url;

            canvas.width = background.width;
            canvas.height = background.height;

            ctx.canvas.width = canvas.width;
            ctx.canvas.height = canvas.height;
        }

        // new position from mouse event
        function setPosition(e) {
            var rect = canvas.getBoundingClientRect();
            pos.x = e.clientX - rect.left;
            pos.y = e.clientY - rect.top;
        }

        function draw(e) {
            // mouse left button must be pressed
            if (e.buttons !== 1) return;

            ctx.beginPath(); // begin

            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000000';

            ctx.moveTo(pos.x, pos.y); // from
            setPosition(e);
            ctx.lineTo(pos.x, pos.y); // to

            ctx.stroke(); // draw it!
        }

        function save(e) {
            //var img_data = ctx.getImageData(0, 0, canvas.width, canvas.height);
            var img_data = canvas.toDataURL("image/png")
            //console.log(img_data);

            drawing_field.value = img_data;
        }

    </script>
    </div>
{% endblock %}
